<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>SunTower | Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        body {
            background: #fafbfc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            overflow-x: hidden;
        }

        main.content {
            margin-left: 250px;
            padding: 2.5rem 3rem;
            margin-top: 70px;
        }

        /* Minimalist stat cards */
        .stat-card {
            border: none;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.75rem;
            transition: all .5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        /* Gradient border effect */
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, transparent, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: all .5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ripple effect */
        .stat-card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all .6s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            z-index: 0;
        }

        /* Primary card colors */
        .stat-card.primary::before {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }

        .stat-card.primary::after {
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent);
        }

        .stat-card.primary .icon-wrapper {
            background: linear-gradient(135deg, #dbeafe, #ede9fe);
            color: #3b82f6;
        }

        /* Success card colors */
        .stat-card.success::before {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-card.success::after {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.3), transparent);
        }

        .stat-card.success .icon-wrapper {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #10b981;
        }

        /* Warning card colors */
        .stat-card.warning::before {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-card.warning::after {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.3), transparent);
        }

        .stat-card.warning .icon-wrapper {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #f59e0b;
        }

        /* Danger card colors */
        .stat-card.danger::before {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .stat-card.danger::after {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.3), transparent);
        }

        .stat-card.danger .icon-wrapper {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #ef4444;
        }

        /* Icon wrapper */
        .stat-card .icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            transition: all .5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Text elements */
        .stat-card .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            transition: all .3s ease;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            transition: all .3s ease;
        }

        /* Hover effects */
        .stat-card:hover {
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.18), 0 12px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-12px) scale(1.02);
            background: rgba(255, 255, 255, 1);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover::after {
            width: 500px;
            height: 500px;
            opacity: 1;
        }

        .stat-card:hover .icon-wrapper {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover .stat-value {
            transform: scale(1.05);
        }

        .stat-card:hover .stat-label {
            color: #374151;
        }

        /* Active/Click effect */
        .stat-card:active {
            transform: translateY(-8px) scale(1.01);
            transition: all .1s ease;
        }

        .stat-card>* {
            position: relative;
            z-index: 1;
        }

        /* Clean chart cards */
        .chart-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            height: 100%;
        }

        .chart-card .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-card .chart-title i {
            font-size: 1.125rem;
            color: #6b7280;
        }

        /* Minimal table */
        .minimal-table {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .minimal-table .table-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #111827;
            font-size: 1rem;
        }

        .minimal-table table {
            margin: 0;
        }

        .minimal-table thead th {
            background: #f9fafb;
            border: none;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .minimal-table tbody td {
            padding: 1rem;
            border: none;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            vertical-align: middle;
        }

        .minimal-table tbody tr:last-child td {
            border-bottom: none;
        }

        .minimal-table tbody tr:hover {
            background: #f9fafb;
        }

        /* Badge styles */
        .badge-minimal {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Rankings */
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .rank-1 {
            background: #fef3c7;
            color: #92400e;
        }

        .rank-2 {
            background: #e5e7eb;
            color: #374151;
        }

        .rank-3 {
            background: #fed7aa;
            color: #9a3412;
        }

        /* Recent list */
        .recent-list {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .recent-list .list-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #111827;
            font-size: 1rem;
        }

        .recent-list .list-group-item {
            border: none;
            border-bottom: 1px solid #f3f4f6;
            padding: 1rem 1.5rem;
            background: transparent;
        }

        .recent-list .list-group-item:last-child {
            border-bottom: none;
        }

        .recent-list .list-group-item:hover {
            background: #f9fafb;
        }

        /* Page header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .page-header .update-time {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .minimal-table tbody tr {
            transition: all 0.2s ease;
        }

        .minimal-table tbody tr:hover {
            background: #f0f9ff;
            transform: translateX(4px);
            box-shadow: inset 3px 0 0 #3b82f6;
        }

        .minimal-table tbody tr:hover td {
            color: #1e40af;
        }

        .minimal-table tbody tr:hover .rank-badge {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .minimal-table tbody tr:hover .badge {
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <!-- HEADER + SIDEBAR -->
    <div th:replace="~{layout/header :: header}"></div>
    <div th:replace="~{layout/sidebar :: sidebar}"></div>

    <main class="content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="page-header">
                <h2>Dashboard</h2>
                <div class="update-time">
                    Cập nhật lần cuối: <span th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy HH:mm')}"></span>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card primary" onclick="window.location='/admin/building/list'">
                        <div class="icon-wrapper"><i class="bi bi-building"></i></div>
                        <div class="stat-label">Tòa nhà</div>
                        <div class="stat-value" th:text="${totalBuildings}"></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card success" onclick="window.location='/admin/customer/list'">
                        <div class="icon-wrapper"><i class="bi bi-people"></i></div>
                        <div class="stat-label">Khách hàng</div>
                        <div class="stat-value" th:text="${totalCustomers}"></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card warning" onclick="window.location='/admin/staff/list'">
                        <div class="icon-wrapper"><i class="bi bi-person-badge"></i></div>
                        <div class="stat-label">Nhân viên</div>
                        <div class="stat-value" th:text="${totalStaffs}"></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card danger" onclick="window.location='/admin/contract/list'">
                        <div class="icon-wrapper"><i class="bi bi-file-earmark-text"></i></div>
                        <div class="stat-label">Hợp đồng</div>
                        <div class="stat-value" th:text="${totalContracts}"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row g-4 mb-4">
                <div class="col-lg-8">
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="bi bi-graph-up"></i>
                            Doanh thu theo tháng của năm <span th:text="${currentYear}"></span>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="bi bi-pie-chart"></i>
                            Tòa nhà theo quận
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="districtChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="bi bi-bar-chart"></i>
                            Doanh thu 3 năm
                        </div>
                        <div style="position: relative; height: 250px;">
                            <canvas id="revenue3YearChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="bi bi-buildings"></i>
                            Hợp đồng theo tòa nhà
                        </div>
                        <div style="position: relative; height: 250px;">
                            <canvas id="contractsByBuildingChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-card">
                        <div class="chart-title">
                            <i class="bi bi-calendar3"></i>
                            Hợp đồng theo năm
                        </div>
                        <div style="position: relative; height: 250px;">
                            <canvas id="contract3YearChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tables Row -->
            <div class="row g-4 mb-4">
                <!-- Recent Buildings -->
                <div class="col-lg-6">
                    <div class="recent-list">
                        <div class="list-header">Tòa nhà thêm gần đây</div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item" th:each="building : ${recentBuildings}"
                                th:onclick="|window.location='/admin/building/' + ${building.id}|"
                                style="cursor: pointer;">
                                <strong th:text="${building.name}"></strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                    Quản lý: <span th:text="${building.managerName}"></span>
                                </div>
                            </li>
                            <li class="list-group-item text-center" style="color: #9ca3af;"
                                th:if="${#lists.isEmpty(recentBuildings)}">
                                Không có dữ liệu gần đây
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="col-lg-6">
                    <div class="minimal-table">
                        <div class="table-header">Top khách hàng</div>
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Top</th>
                                    <th>Mã KH</th>
                                    <th>Tên khách hàng</th>
                                    <th style="text-align: right;">Hợp đồng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="customer, iter : ${potentialCustomers}"
                                    th:onclick="|window.location='/admin/customer/' + ${customer.customerId}|"
                                    style="cursor: pointer;">
                                    <td>
                                        <span class="rank-badge"
                                            th:classappend="${iter.index == 0 ? 'rank-1' : iter.index == 1 ? 'rank-2' : iter.index == 2 ? 'rank-3' : ''}"
                                            th:text="${iter.index + 1}">
                                        </span>
                                    </td>
                                    <td th:text="${customer.customerId}"></td>
                                    <td th:text="${customer.fullName}"></td>
                                    <td style="text-align: right;">
                                        <span class="badge bg-primary badge-minimal"
                                            th:text="${customer.contractCount}"></span>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(potentialCustomers)}">
                                    <td colspan="4" class="text-center" style="color: #9ca3af;">Không có dữ liệu</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top Staff Table -->
            <div class="minimal-table">
                <div class="table-header">Top 5 nhân viên hiệu suất cao</div>
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Top</th>
                            <th>Mã NV</th>
                            <th>Tên nhân viên</th>
                            <th style="text-align: center;">Hợp đồng</th>
                            <th style="width: 200px;">Tỷ lệ đóng góp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="staff, iter : ${topStaffs}"
                            th:onclick="|window.location='/admin/staff/' + ${staff.staffId}|" style="cursor: pointer;">
                            <td>
                                <span class="rank-badge"
                                    th:classappend="${iter.index == 0 ? 'rank-1' : iter.index == 1 ? 'rank-2' : iter.index == 2 ? 'rank-3' : ''}"
                                    th:text="${iter.index + 1}">
                                </span>
                            </td>
                            <td th:text="${staff.staffId}"></td>
                            <td th:text="${staff.fullName}"></td>
                            <td style="text-align: center;" th:text="${staff.contractCount}"></td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-success" th:style="'width:' + ${staff.performancePercent} + '%'">
                                    </div>
                                </div>
                                <small style="font-weight: 600; color: #6b7280; min-width: 40px;"
                                    th:text="${staff.performancePercent + '%'}"></small>
            </div>
            </td>
            </tr>
            <tr th:if="${#lists.isEmpty(topStaffs)}">
                <td colspan="5" class="text-center" style="color: #9ca3af;">Chưa có dữ liệu hiệu suất</td>
            </tr>
            </tbody>
            </table>
        </div>
        </div>
    </main>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Boostrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        // Chart default config
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        Chart.defaults.color = '#6b7280';

        // Revenue Chart - Monthly
        const revenueData = /*[[${monthlyRevenue}]]*/[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        new Chart(document.getElementById('revenueChart'), {
            type: 'line',
            data: {
                labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                datasets: [{
                    label: 'Doanh thu (tỷ VNĐ)',
                    data: revenueData.map(v => v / 1_000_000_000),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.95)',
                        padding: 12,
                        borderColor: '#e5e7eb',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6' },
                        border: { display: false }
                    },
                    x: {
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        });

        // District Chart
        const districtNames = /*[[${districtNames}]]*/[];
        const districtCounts = /*[[${districtCounts}]]*/[];
        new Chart(document.getElementById('districtChart'), {
            type: 'doughnut',
            data: {
                labels: districtNames,
                datasets: [{
                    data: districtCounts,
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 12,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    }
                }
            }
        });

        // 3 Year Revenue Chart
        const revenue3YearLabels = [
    /*[[${yearBeforeLast}]]*/ 2022,
    /*[[${lastYear}]]*/ 2023,
    /*[[${currentYear}]]*/ 2024
        ];
        const revenue3YearValues = /*[[${yearlyRevenue}]]*/[0, 0, 0];
        new Chart(document.getElementById('revenue3YearChart'), {
            type: 'bar',
            data: {
                labels: revenue3YearLabels,
                datasets: [{
                    label: 'Doanh thu (tỷ VNĐ)',
                    data: revenue3YearValues.map(v => v / 1_000_000_000),
                    backgroundColor: '#3b82f6',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6' },
                        border: { display: false }
                    },
                    x: {
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        });

        // 3 Year Contracts Chart
        const contractYearLabels = /*[[${contractYearLabels}]]*/[];
        const contractYearCounts = /*[[${contractYearCounts}]]*/[];
        new Chart(document.getElementById('contract3YearChart'), {
            type: 'line',
            data: {
                labels: contractYearLabels,
                datasets: [{
                    label: 'Số hợp đồng',
                    data: contractYearCounts,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6' },
                        border: { display: false },
                        ticks: {
                            stepSize: 1,
                        }
                    },
                    x: {
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        });

        // Contracts by Building Chart
        const buildingNames = /*[[${buildingNames}]]*/[];
        const buildingContractCounts = /*[[${buildingContractCounts}]]*/[];
        new Chart(document.getElementById('contractsByBuildingChart'), {
            type: 'bar',
            data: {
                labels: buildingNames,
                datasets: [{
                    label: 'Số hợp đồng',
                    data: buildingContractCounts,
                    backgroundColor: '#3b82f6',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (item) => `${item.raw} hợp đồng`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6' },
                        border: { display: false },
                        ticks: { precision: 0 }
                    },
                    y: {
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        });
    </script>
</body>

</html>